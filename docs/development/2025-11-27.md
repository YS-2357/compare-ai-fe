# 2025-11-27 개발 로그

- **오전 상황**
  1. 백엔드 모듈 구조 분리: `app/auth.py`, `app/rate_limit.py`, `app/services/langgraph.py`를 각각 패키지(`app/auth/*`, `app/rate_limit/*`, `app/services/langgraph/*`)로 재배치해 폴더 구조 정돈만 수행.
  2. API 의존성/스키마 분리: `app/api/deps.py`, `app/api/schemas/ask.py` 추가하고 `routes.py`에서 새 경로로 import 정리.
  3. LangGraph 파일 분할: `llm_registry.py`(클라이언트/환경), `nodes.py`(call_* 노드), `workflow.py`(StateGraph/stream), `summaries.py`(요약 유틸), `__init__.py`로 구성.
  4. 빌드 확인: `python3 -m compileall app` 통과(의존 패키지 호출 없음, 코드 구조 검증 목적).
- **변경 내용**
  - 삭제: `app/auth.py`, `app/rate_limit.py`, `app/services/langgraph.py` (패키지로 이동).
  - 추가: `app/auth/{__init__,dependencies,supabase}.py`, `app/rate_limit/{__init__,dependencies,upstash}.py`.
  - 추가: `app/api/deps.py`, `app/api/schemas/{__init__,ask}.py`.
  - 추가: `app/services/langgraph/{__init__,llm_registry,nodes,summaries,workflow}.py`.
  - `app/api/routes.py` import 경로 수정, `app/services/__init__.py`는 `stream_graph`만 노출 유지.
- **추가 진행 (오전)**
  1. 회원가입/로그인 엔드포인트 추가: `app/api/auth_routes.py`에 `/auth/register`, `/auth/login` 구현(Supabase Auth signUp/signIn).
  2. 인증 스키마 분리: `app/api/schemas/auth.py`에 Register/Login 요청·응답 모델 추가.
  3. Supabase Auth 클라이언트: `app/auth/supabase.py`에 `SupabaseAuthClient`/`get_auth_client` 추가, 설정에 `SUPABASE_ANON_KEY`/`SUPABASE_SERVICE_ROLE_KEY` 필드 반영(`config.py`).
  4. API 라우터 통합: `app/api/__init__.py`에서 auth/public 라우터 포함하도록 구성.
  5. 빌드 확인: `python3 -m compileall app` 통과.
- **추가 진행 (오후)**
  1. 사용량 기본 제한: `app/config.py`의 `DAILY_USAGE_LIMIT` 기본값을 3회로 축소(환경변수로 override 가능).
  2. UI 로그인 가드: `app/ui/streamlit_app.py`에서 로그인/관리자 우회 토큰 없이 `/api/ask` 호출 불가하도록 차단.
  3. 인증: JWKS 404/401 대응으로 `app/auth/supabase.py`가 `.well-known/jwks.json` 등 여러 경로로 폴백, `apikey` 쿼리/헤더 포함.
  4. 레이트리밋 안정화: Upstash 연결 오류 시 경고 로그만 남기고 우회(`app/rate_limit/dependencies.py`), 429만 강제 차단.
  5. 동작 확인: `.well-known/jwks.json` 기반 검증 + Upstash 우회로 `/api/ask` 정상 동작 확인.
- **다음 할 일(TODO)**
  1. UI 리브랜딩: Streamlit 제목/레이아웃을 “Compare-AI”로 교체하고 전반 스타일 정리.
  2. LangGraph/백엔드 리팩터링: `services/langgraph` 공통화 및 멀티턴 확장, 전체 코드 영역별 정리.
  3. FE 분리/배포: `compare-ai-fe`로 프런트 분리 후 BE 호출 연동 및 배포 확인.
  4. 인증 확장: 비밀번호 변경(찾기 대신), 회원탈퇴, 이메일 인증 후 흐름 정리.
- **후속 예정**
  - README/문서의 모듈 경로 업데이트.
  - LangGraph call_* 중복 로직 공통화 및 멀티턴 확장 포인트 추가.
  - 인증/레이트리밋 예외/로그 메시지 정돈, 환경변수 표 정리(.env.example/README). 
