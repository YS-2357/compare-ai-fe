# 2025-11-22 개발 로그

- **상태 요약**: 이모지 로거 출력 단축 및 차기 멀티턴/후처리 작업 계획 수립
- **변경 사항**:
  1. `app/logger.py` 포맷을 `HH:MM:SS` + 레벨 이니셜만 남기도록 수정
  2. 멀티턴 Send 플로우(요약→재입력), 모델 응답 후처리, 비동기 HTTPX 전환, 오류 재시도 전략을 로드맵에 명시
  3. `GraphState` 기본값을 정비해 `max_turns=3`, `turn=1`, `conversation_history`/`current_inputs`/`active_models` 등을 초기화하여 서비스 중단 없이 멀티턴 준비 완료
- **오늘의 실행 계획**
  - 설계 문서 정리 및 우선순위 확정
  - send 후처리·비동기 HTTPX·재시도 로직을 다음 작업으로 backlog에 적재
  - 실제 구현 작업은 설계 완료 후 순차 진행
- **미해결 과제**
  - 요약 집계/다음 입력 생성/턴 제어 노드를 LangGraph에 추가해 실제 멀티턴 루프 구성
  - LCEL 템플릿/OutputParser를 설계해 모델별 재입력 프롬프트를 정형화하고, 프론트엔드에서 턴 수·활성 모델을 조절하는 UI 제공
- **다음 단계 (Backlog)**
  1. 요약/입력 생성 노드와 턴 제어 노드를 설계하고 LCEL 기반으로 구현
  2. Send fan-out 결과를 재정렬/재시도할 후처리 함수 작성
  3. Streamlit HTTP 호출을 비동기(`httpx.AsyncClient`)로 전환할 feasibility 검토
  4. 오류 이벤트 기반 재시도/알림 훅 설계 및 구현

## 멀티턴 구현 기준 (합의)
- 턴 증가 규칙: 사용자가 재입력을 보내면 `turn += 1` 처리한다. 재입력 직후 요약을 생성하고 그 요약/히스토리를 사용해 다시 LLM fan-out을 수행한다. `turn > max_turns`가 되는 경우 요약을 만들지 않고 “턴 초과” 경고만 응답한다.
- 요약 길이 가드: 요약은 2문장 이내(약 400자 내외)로 강제한다. 응답이 길더라도 요약 프롬프트에서 길이를 제한한다.
- 재질문 전략: 자동 재질문 없음(유료 정책). 모든 턴은 사용자 입력을 받아 진행하며, max_turns를 넘지 않도록 사용자 경험만 제한한다.
- fan-out/반복: 각 사용자 입력당 한 번의 fan-out만 수행하고, 추가 반복 실행은 하지 않는다.
- 이벤트/상태 기본값: 이벤트 타입은 `partial`(모델별 결과), `summary`(요약 완료), `error`(오류)를 기본으로 하고 필요 시 `end`를 추가한다. 상태 키는 현행 `GraphState` 중심으로 유지하고, 필요한 경우 `next_question`(사용자 재입력 반영), `end_reason`(턴 초과 등)만 추가한다.

## 멀티턴 구현 결과
- LangGraph 실행은 단일 턴만 수행하고, `turn > max_turns` 시 즉시 경고 이벤트를 반환해 요약/LLM 호출을 생략한다.
- 이전 히스토리(`history`)를 받아 2문장·400자 이하로 요약한 뒤 모델별 프롬프트에 포함한다.
- `/api/ask` 요청 스키마에 `turn`, `max_turns`, `history`를 추가하고 스트림 이벤트에 턴 정보를 포함했다.
- Streamlit은 사용자 입력마다 턴을 계산해(`기존 user 메시지 수 + 1`) `history`와 함께 API에 전달하며, 최대 턴 초과 시 즉시 경고를 표시한다.

## 오늘 추가 개선
- 프롬프트에 “5문장 이하/600자 이내” 제약을 추가해 모델 응답 길이를 줄임 (`app/services/langgraph.py`).
- 스트림 상태에 이모지(✅/⚠️/❌)를 붙여 에러 가시성을 높임 (`app/ui/streamlit_app.py`).
- 요약 섹션에서 모델별 상태/시간을 Streamlit 표로 직접 렌더링해 마크다운 표 깨짐 문제를 해소 (`app/ui/streamlit_app.py`).

## 추가 메모 / TODO
- Streamlit에서 상태/시간 표가 여전히 마크다운 텍스트로만 표시됨. 다음 작업 때 `st.table`/`st.dataframe` 또는 HTML 렌더링으로 교체해 실제 표로 표시 필요.
